<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Simulate NFC Tap with GPS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
<div class="container mt-5 p-4 bg-white rounded shadow-sm" style="max-width: 600px;">
    <h3 class="mb-4">Simulate NFC Tap with Auto GPS</h3>

    {% if message %}
    <div class="alert {{ 'alert-success' if 'âœ…' in message else 'alert-danger' }}">{{ message|safe }}</div>
    {% endif %}

    <form method="POST" class="mb-4" id="simulateForm">
        <div class="mb-3">
            <label for="card_id" class="form-label">Select User Card</label>
            <select class="form-select" name="card_id" id="card_id" required>
                <option value="" disabled selected>Select a card</option>
                {% for cid, full_name in users.items() %}
                <option value="{{ cid }}">{{ full_name }} ({{ cid }})</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label>Start Location (auto-detected)</label>
            <input type="text" readonly class="form-control mb-2" id="start_coords_display" placeholder="Waiting for GPS..." />
            <input type="hidden" name="start_lat" id="start_lat" required />
            <input type="hidden" name="start_lon" id="start_lon" required />
        </div>

        <div class="mb-3">
            <label>End Location (auto-detected)</label>
            <input type="text" readonly class="form-control mb-2" id="end_coords_display" placeholder="Waiting for GPS..." />
            <input type="hidden" name="end_lat" id="end_lat" required />
            <input type="hidden" name="end_lon" id="end_lon" required />
        </div>

        <button type="submit" class="btn btn-primary w-100" id="submitBtn" disabled>Waiting for GPS...</button>
    </form>
</div>

<script>
    const startLatInput = document.getElementById('start_lat');
    const startLonInput = document.getElementById('start_lon');
    const startDisplay = document.getElementById('start_coords_display');

    const endLatInput = document.getElementById('end_lat');
    const endLonInput = document.getElementById('end_lon');
    const endDisplay = document.getElementById('end_coords_display');

    const submitBtn = document.getElementById('submitBtn');

    function setCoords(latInput, lonInput, displayInput, position) {
        const lat = position.coords.latitude.toFixed(6);
        const lon = position.coords.longitude.toFixed(6);
        latInput.value = lat;
        lonInput.value = lon;
        displayInput.value = `${lat}, ${lon}`;
    }

    function errorHandler(error) {
        alert(`Error getting location: ${error.message}`);
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit (with manual input needed)";
    }

    // Get Start Location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            setCoords(startLatInput, startLonInput, startDisplay, position);

            // After start location is ready, get end location
            navigator.geolocation.getCurrentPosition(position2 => {
                setCoords(endLatInput, endLonInput, endDisplay, position2);
                submitBtn.disabled = false;
                submitBtn.textContent = "Simulate Tap";
            }, errorHandler);
        }, errorHandler);
    } else {
        alert('Geolocation is not supported by your browser.');
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit (manual)";
    }
</script>
</body>
</html>
